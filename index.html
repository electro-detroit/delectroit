<!DOCTYPE html>
<html>
<head>
    <!--Bootstrap framework-->
    <!-- Bootstrap CSS (needed for modal styling) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- jQuery (required by jQuery UI) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- jQuery UI files -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <!-- jQuery UI Touch js (required for touchscreen use) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous"></script>
    <!--Leaflet CSS (latest)-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@latest/dist/leaflet.css" />
    <!--Leaflet JS (latest)-->
    <script src="https://unpkg.com/leaflet@latest/dist/leaflet.js"></script>

    <!-- Leaflet Time-Slider plugin (SliderControl) -->
    <script src="js/SliderControl.js"></script>

    <title>Delectroit</title>

  <style>
  html { height: 100% }
  body { height: 100%; margin: 0; padding: 0; padding-top: 160px; /* keep navbar space */ } 

  /* taller purple navbar with centered title */
  .navbar.fixed-top{
    /* use the attached image as a full-width background and keep the purple tint */
    background: linear-gradient(90deg, rgba(111,66,193,0.45), rgba(142,68,204,0.45)), url("Assets/Detroit Skyline 2.jpg") center/cover no-repeat;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    height: 160px;
    box-shadow: 0 10px 24px rgba(111,66,193,0.12);
    width: 100%;
    left: 0;
    right: 0;
  }

  /* hide the inline <img> inside .navbar-brand (optional if you remove the tag) */
  .navbar-brand img.navbar-brand-img {
    display: none;
  }

  /* make sure brand text sits above the background */
  .navbar-brand {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
    z-index: 2;
    color: #fff !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.6);
  }

  /* move the toggler to the right so it doesn't sit left of the centered title */
  .navbar-toggler {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
  }

  /* make the map fill the remaining viewport under the navbar and prevent page scroll */
  .map { height: calc(100vh - 160px); min-height: 0; max-height: none; }
  /* option B (alternate): fixed px height, e.g. 600px */
  /* .map { height: 600px; } */

  /* Bootstrap-icon marker styling */
  .bi-marker {
    font-size: 40px;        /* increased marker size */
    color: #6f42c1;         /* purple marker color */
    line-height: 1;
    display: inline-block;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    transform: translateY(2px); /* tweak to visually center larger icon */
  }

  /* popup color overrides (light purple background, darker purple border/text) */
  .leaflet-popup-content-wrapper {
    background: #f3e8ff;            /* light purple background */
    color: #2e1050;                 /* popup text color */
    border: 2px solid #6f42c1;      /* purple border */
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(111,66,193,0.18);

    /* enforce consistent, smaller popup size */
    max-width: 420px !important;
    width: 420px !important;
    max-height: 300px !important;
    overflow: hidden;
  }
  .leaflet-popup-tip,
  .leaflet-popup-tip-container {
    color: #f3e8ff;
  }
  .leaflet-popup-content {
    margin: 8px 12px;
    font-size: 14px;

    /* make popup body scrollable when content exceeds fixed height */
    max-height: 220px;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  /* popup image sizing to keep layout consistent */
  .leaflet-popup-content .popup-img{
    width: 100%;
    max-height: 120px;
    object-fit: cover;
    display: block;
    margin: 0 0 8px 0;
    border-radius: 6px;
  }
  .popup-center {
    text-align: center;
  }

  /* remove the white/tinted box behind the navbar collapsed panel */
  #navbarTop {
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
    backdrop-filter: none !important;
  }
    /* apply the purple-tinted panel only when the collapse is open (Bootstrap adds .show) */
    #navbarTop.show {
      background: rgba(147,119,215,0.18) !important;
      backdrop-filter: blur(6px);
      border-radius: 8px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06), 0 4px 12px rgba(111,66,193,0.06);
      border: 1px solid rgba(111,66,193,0.08);
      color: #000;
    }
    #navbarTop.show .navbar-nav { gap: .5rem; align-items: center; }
    #navbarTop.show .nav-item .nav-link {
      color: #000 !important;
      padding: .35rem .6rem;
      border-radius: 6px;
      font-weight: 500;
    }
    #navbarTop.show .nav-item .nav-link:hover {
      background: rgba(111,66,193,0.08);
      color: #000 !important;
    }

    /* Purple slider styles (SliderControl / jQuery UI / range fallback)
       Stronger overrides: force visible, fixed above map (so it cannot be clipped),
       keep purple look and make it very wide. */
    .leaflet-control-slider,
    .slider-control,
    .leaflet-control.slider-control {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;

      /* use fixed positioning so the control bypasses any Leaflet container clipping */
      position: fixed !important;
      top: calc(160px + 12px) !important; /* place below your 160px header */
      left: 50% !important;
      transform: translateX(-50%) !important;

      /* purple panel look */
      background: linear-gradient(90deg, rgba(111,66,193,0.16), rgba(142,68,204,0.12));
      padding: 12px 18px;
      border-radius: 14px;
      border: 1px solid rgba(111,66,193,0.14);
      box-shadow: 0 14px 50px rgba(111,66,193,0.18);
      color: #3a0f52;
      pointer-events: auto;

      /* make the slider very wide but responsive */
      width: min(1400px, calc(100% - 96px)) !important;
      max-width: calc(100% - 96px) !important;
      box-sizing: border-box;

      z-index: 99999 !important; /* ensure on top of everything */
    }

    /* also override any Leaflet container rules that might re-position/clip it */
    .leaflet-top .leaflet-control-slider,
    .leaflet-bottom .leaflet-control-slider {
      position: fixed !important;
      top: calc(160px + 12px) !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      width: min(1400px, calc(100% - 96px)) !important;
      z-index: 99999 !important;
    }

    /* track / handle styling kept purple and prominent */
    .slider-control .ui-slider,
    .leaflet-control-slider .ui-slider {
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(111,66,193,0.10), rgba(142,68,204,0.07));
      width: 100%;
      margin: 8px 0;
    }

    .slider-control .ui-slider .ui-slider-range,
    .leaflet-control-slider .ui-slider .ui-slider-range {
      background: #6f42c1;
      border-radius: 999px;
      box-shadow: 0 3px 10px rgba(111,66,193,0.18) inset;
    }

    .slider-control .ui-slider .ui-slider-handle,
    .leaflet-control-slider .ui-slider .ui-slider-handle,
    .leaflet-control-slider input[type="range"]::-webkit-slider-thumb,
    .slider-control input[type="range"]::-webkit-slider-thumb,
    .leaflet-control-slider input[type="range"]::-moz-range-thumb,
    .slider-control input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      background: #6f42c1;
      border: 3px solid #fff;
      border-radius: 50%;
      box-shadow: 0 8px 22px rgba(111,66,193,0.26);
      margin-top: -6px;
    }

    /* keep responsive fallback */
    @media (max-width: 760px) {
      .leaflet-control-slider,
      .slider-control,
      .leaflet-control.slider-control {
        width: calc(100% - 32px) !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        top: calc(160px + 8px) !important;
        max-width: calc(100% - 32px) !important;
      }
    }

    /* small date / label tweak */
    .leaflet-control-slider .date,
    .slider-control .date,
    .leaflet-control-slider .current-date {
      color: #40105a;
      font-weight: 600;
      padding-left: 8px;
      background: transparent;
    }
  </style>
  </head>
<body>

<!-- Top navigation bar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">Delectroit</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTop" aria-controls="navbarTop" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarTop">
      <ul class="navbar-nav ms-auto align-items-center d-flex flex-row gap-2">
         <li class="nav-item">
           <a class="nav-link px-2" id="about-link" href="about.html">About</a>
         </li>
         <li class="nav-item">
           <a class="nav-link px-2" id="teams-link" href="teams.html">Teams</a>
         </li>
      </ul>

      <!-- ensure the collapsed container is shown by default (makes links visible) -->
      <script>
        document.addEventListener('DOMContentLoaded', function(){
          var c = document.getElementById('navbarTop');
          if (c && !c.classList.contains('show')) c.classList.add('show');
        });
      </script>
        </div>
  </div>
</nav>

<div id="map" class="map"></div>
<!--
<main class="container py-4">
  <section class="section-card">
    <h2>More content</h2>
    <p>Add your page content here — longer content will produce vertical scroll.</p>
  </section>
</main>
-->

<!-- Nav modal -->
<div class="modal fade" id="navModal" tabindex="-1" aria-labelledby="navModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div style="width:100%; display:flex; align-items:center; gap:12px;">
          <div style="flex:1; background:linear-gradient(90deg,#6f42c1,#8e44cc); color:#fff; padding:10px 14px; border-radius:6px;">
            <h5 class="modal-title mb-0" id="navModalLabel">Delectroit — Navigation</h5>
            <small id="navModalSub" class="d-block" style="opacity:.9;">Quick actions & map controls</small>
            <p class="mb-0 mt-2" style="font-size:13px; line-height:1.3; opacity:0.95;">
              Welcome to Delectroit, a mapping project showcasing Detroit's vibrant sound art scene. Explore the locations of various sound installations and venues across the city.
              <br><strong>Created:</strong> 2021 ADD DESCRIPTION
            </p>
          </div>

          <div class="btn-group ms-2" role="group" aria-label="Nav controls" style="align-self:flex-start;">
            <button type="button" class="btn btn-sm btn-light" title="Show project description"
              onclick="(function(){ var modal=document.getElementById('navModal'); var body=modal.querySelector('.modal-body'); body.innerHTML = '<p class=&quot;mb-2&quot;><strong>Delectroit:</strong> Interactive map of Detroit sound-art venues and installations. Click markers for details.</p>'; })()">
              <i class="bi bi-info-circle-fill"></i>
            </button>
 
             <button type="button" class="btn btn-sm btn-outline-light" title="Toggle purple header help"
               onclick="(function(btn){ var sub=document.getElementById('navModalSub'); sub.textContent = sub.textContent.startsWith('Quick') ? 'Use the icons to quickly control the map.' : 'Quick actions & map controls'; })(this)">
               <i class="bi bi-sliders"></i>
             </button>
           </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Controls for nav modal: zoom / fit markers -->
        <div class="d-flex gap-2">
          <button id="zoom-detroit" class="btn btn-sm btn-primary">Zoom to Detroit</button>
          <button id="fit-markers" class="btn btn-sm btn-outline-primary">Fit markers</button>
        </div>
       </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- Startup modal that appears on page load - edit the content below -->
<style>
  /* local styles for the startup modal */
  #startupModal .modal-header {
    background: linear-gradient(90deg,#9775d7,#7d51a1);
    color: #fff;
    border-bottom: none;
    align-items:center;
  }
  #startupModal .modal-title {
    margin:0;
    font-weight:600;
  }
  #startupModal .startup-badge {
    width:44px;
    height:44px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    background: rgba(255,255,255,0.12);
    border-radius:8px;
    margin-right:10px;
    font-size:20px;
  }
  #startupModal .modal-body { font-size:14px; color:#2b0b4d; }
  #startupModal .tip { font-weight:500; margin-bottom:8px; }
  #startupModal .small-muted { opacity:0.85; font-size:13px; }
  #startupModal .dont-show { display:flex; align-items:center; gap:8px; }
  #startupModal img.startup-img { width:100%; max-height:120px; object-fit:cover; border-radius:6px; display:block; margin-bottom:8px; }
  #startupModal .modal-footer { display:flex; gap:8px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
  @media (min-width:560px){
    #startupModal .modal-body-flex { display:flex; gap:12px; }
    #startupModal .text-col { flex:1; }
    #startupModal .img-col { width:160px; flex:0 0 160px; }
  }
</style>

<div class="modal fade" id="startupModal" tabindex="-1" aria-labelledby="startupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div style="display:flex; align-items:center; gap:10px; width:100%;">
          <div class="startup-badge" aria-hidden="true">
            <i class="bi bi-speaker-fill" style="color:#fff;"></i>
          </div>
          <div style="flex:1;">
            <h5 class="modal-title" id="startupModalLabel">Welcome to Delectroit</h5>
            <small class="small-muted">Explore sound art & venues across Detroit.</small>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="modal-body-flex">
          <div class="text-col">
            <!-- startup tip removed -->
            <div class="small-muted">
              Click markers for details, or use the Menu to zoom and fit markers.
            </div>

            <div style="margin-top:12px;" class="dont-show">
              <input type="checkbox" id="dontShow" />
              <label for="dontShow" style="margin:0; font-size:13px;">Don't show this again</label>
            </div>
          </div>

          <!-- image removed -->
        </div>
      </div>

      <div class="modal-footer">
        <div style="display:flex; gap:8px;">
          <button id="exploreBtn" type="button" class="btn btn-sm btn-primary">Explore map</button>
          <button type="button" class="btn btn-sm btn-outline-light" data-bs-dismiss="modal">Close</button>
        </div>
        <small class="small-muted">v1 • Delectroit (BHY)</small>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  var modalEl = document.getElementById('startupModal');
  if (!modalEl) return;

  // "Don't show again" handling
  var dont = modalEl.querySelector('#dontShow');
  if (dont) {
    dont.addEventListener('change', function(){
      try {
        if (dont.checked) localStorage.setItem('hideStartupModal','true');
        else localStorage.removeItem('hideStartupModal');
      } catch(e){}
    });
  }

  // "Explore map" button: zoom to Detroit and close
  var exploreBtn = modalEl.querySelector('#exploreBtn');
  if (exploreBtn) {
    exploreBtn.addEventListener('click', function(){
      if (window.map && typeof map.setView === 'function') map.setView([42.3314,-83.0458],10);
      var modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modalInstance.hide();
    });
  }

  // On DOMContentLoaded, if user asked not to show again, remove the modal element so it won't appear
  document.addEventListener('DOMContentLoaded', function(){
    try {
      if (localStorage.getItem('hideStartupModal') === 'true') {
        modalEl.parentNode && modalEl.parentNode.removeChild(modalEl);
      } else {
        // show the modal on first load (Bootstrap 5)
        var modalInstance = new bootstrap.Modal(modalEl);
        modalInstance.show();
      }
    } catch(e){}
  });
})();
</script>

<script>
// center on Detroit, MI (zoomed out more)
var map = L.map('map').setView([42.3314, -83.0458], 10);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// collect markers for fitBounds
var allMarkers = L.featureGroup();

// (removed duplicate whenReady here — initial fit/zoom is handled later after markers & slider are added)

  // keep resize handling (only once)
  window.addEventListener('resize', function(){ map.invalidateSize(); });

  // Use a Bootstrap Icon inside a divIcon
const biHtml = `<i class="bi bi-speaker-fill bi-marker" aria-hidden="true"></i>`;
const speakerIcon = L.divIcon({
  className: '',           // keep empty so only our <i> styles apply
  html: biHtml,
  iconSize: [44,44],       // match larger font-size
  iconAnchor: [22,22],     // center the icon on its coordinate
  popupAnchor: [0,-22]
});

// create a layer collection for the slider control
var sliderLayer = L.featureGroup();

// pending markers array so we can add them to the slider in chronological order
var pendingMarkers = [];

// helper to create marker, add time property and push to pendingMarkers (do NOT add to map/slider yet)
function addTimedMarker(lat, lng, popupHtml, timeStr) {
  var opts = { icon: speakerIcon };
  if (timeStr) opts.time = timeStr;
  var m = L.marker([lat, lng], opts);
  m.bindPopup(popupHtml, {
    maxWidth: 520,
    minWidth: 220,
    maxHeight: 360,
    autoPan: false,                  // <-- prevent popup from auto-panning the map
    autoPanPadding: L.point(16, 16),
    autoPanPaddingTopLeft: L.point(0, 160)
  });
  pendingMarkers.push({ marker: m, time: timeStr || null });
  return m;
}

// replace your previous L.marker(...).addTo(map) blocks with addTimedMarker calls
addTimedMarker(42.3280226, -83.0448932, `<div><img src="Assets/Hart_Plaza_Detroit.jpg" alt="Hart Plaza" class="popup-img"><div class="popup-center"><strong>Hart Plaza</strong></div><div>
  <p>Created: 1975</p>
  <p>The Hart Plaza was officially designated as a public space in 1975 and serves as a prime location for music festivals, markets, and large public gatherings. Its open design and riverfront setting make it a focal point for community events and cultural celebrations in Detroit.</p>
  <p>Historically, the site has been considered for multiple civic uses — from a proposed civic center in 1890 to a war memorial in 1924 — and is believed to be near the area where Antoine de la Mothe Cadillac originally settled what became Detroit. The plaza's layered history highlights how changing community priorities shape urban public space.</p>
  </div>
  <ul>
    <li><strong>Name:</strong> Hart Plaza</li>
    <li><strong>Address:</strong><br />1 Hart Plaza, Detroit, MI 48226, USA</li>
    <li><strong>Website:</strong> <a href="https://www.detroithistorical.org/learn/online-research/encyclopedia-of-detroit/hart-plaza" target="_blank" rel="noopener">Detroit Historical Society — Hart Plaza</a></li>
  </ul>
</div>`, '1975');

addTimedMarker(42.3630469, -83.0852008, `<div><img src="Assets/The Marble Bar.jpg" alt="Marble Bar" class="popup-img"><div class="popup-center"><strong>Marble Bar</strong></div><div>
  <p>Created: 2015
  </p>
  <p>The space that is now the Marble Bar was initially a leather daddy bar, opened in 1985. It was marketed as an LGBTQ+ space that allowed community members to express themselves safely. It closed its doors and was reimagined as a live music venue in 2015, thus becoming The Marble Bar.</p>
  <p>The owners of The Marble Bar made intentional changes to the atmosphere and physical appearance of the club in order to distance themselves from the historic memory of the space. The changes made by The Marble Bar ownership are indicative of the various ways that the reimagining of space can contribute to the silencing of marginalized voices.</p>
  </div>
  <ul>
    <li><strong>Name:</strong> Marble Bar</li>
    <li><strong>Address:</strong><br />1501 Holden St, Detroit, MI 48208, USA</li>
    <li><strong>Website:</strong> <a href="https://themarblebar.com/" target="_blank" rel="noopener">themarblebar.com</a></li>
  </ul>
</div>`, '2015');

addTimedMarker(42.3580524, -83.0167091, `<div><img src="Assets/Spot Lite.jpg" alt="Spot Lite" class="popup-img"><div class="popup-center"><strong>Spot Lite Detroit</strong></div><div>
  <p>Created: 2018</p>
  </p>
  <p>Spot Lite Detroit was opened in 2018 by Roula David following a cash infusion by the Motor City March fund. It was envisioned as a multi-use venue for the arts community.</p>
  <p>The space functions as a gallery, bar, and event space and shows how the perspective of a first-generation immigrant can reshape urban landscapes when supported by mainstream institutions.</p>
  </div>
  <ul>
    <li><strong>Name:</strong> Spot Lite Detroit</li>
    <li><strong>Address:</strong><br />2905 Beaufait St, Detroit, MI 48207, USA</li>
    <li><strong>Website:</strong> <a href="https://www.spotlitedetroit.com/" target="_blank" rel="noopener">spotlitedetroit.com</a></li>
  </ul>
</div>`, '2018');

addTimedMarker(42.3726414, -83.0635704, `<div><img src="Assets/Tangent Gallery.jpg" alt="Tangent Gallery and Hastings Street Ballroom" class="popup-img"><div class="popup-center"><strong>Tangent Gallery &amp; Hastings Street Ballroom</strong></div><div>
  <p>Created: 1999</p>
  </p>
  <p>Tangent Gallery &amp; Hastings Street Ballroom opened in 1999 as an eccentric place for the arts and alternative community. The space continues to serve as a premier venue for experimental music and avant‑garde performance art.</p>
  <p>This venue demonstrates how an authentic commitment to community can help bolster the longevity of a cultural space, sustaining artistic practices and local engagement over time.</p>
  </div>
  <ul>
    <li><strong>Name:</strong> Tangent Gallery &amp; Hastings Street Ballroom</li>
    <li><strong>Address:</strong><br />715 Milwaukee Ave, Detroit, MI 48202, USA</li>
    <li><strong>Website:</strong> <a href="https://ra.co/clubs/16250" target="_blank" rel="noopener">Resident Advisor — Tangent Gallery</a></li>
  </ul>
</div>`, '1999');

addTimedMarker(42.3380472, -83.0625672, `<div><img src="Assets/T+V Lounge.jpg" alt="TV Lounge" class="popup-img"><div class="popup-center"><strong>TV Lounge</strong></div><div>
  <p>Created: 2007.</p>
  <p>Marketed as the “longest running and most iconic nightclub in Detroit,” T+V Lounge was rebranded in 2007 by Josh Guerin. The space is a metro hotspot for the music scene, particularly electronic music, House, techno, Afrobeats, Hip Hop, and more.</p>
  <p>T+V Lounge has survived the challenging minefield of Detroit business by keeping its ear to the ground and continuing to be a space that caters to the needs of the community.</p>
  </div>
  <ul>
    <li><strong>Name:</strong> TV Lounge</li>
    <li><strong>Address:</strong><br />2548 Grand River Ave, Detroit, MI 48201, USA</li>
    <li><strong>Website:</strong> <a href="https://www.tvloungedetroit.com/" target="_blank" rel="noopener">tvloungedetroit.com</a></li>
  </ul>
</div>`, '2007');

addTimedMarker(42.3336153, -83.0548439, `<div><img src="Assets/City Club.jpg" alt="Leland City Club" class="popup-img"><div class="popup-center"><strong>Leland City Club</strong></div><div>
    <p>Created: 1983.</p>
     <p>Founded by Mike Higgins as "Liedernacht," Leland City Club transformed from a luxurious casino ballroom into Detroit's premier gothic-industrial venue. Its early 20th-century architecture — classical columns and elaborate moldings — now contrasts with black walls and murals, producing a visual tension that mirrors the venue's sonic identity.</p>
    <p>The dual-room layout creates contested zones: a dimly lit front dance floor and a back room with a massive Nexo Alpha system. High ceilings and ornate details do more than frame the space; they shape sound by absorbing and diffusing frequencies in ways stripped-down modern venues cannot. Leland reimagines historical architecture as a form of resistance to gentrification, turning bourgeois leisure infrastructure into a working-class subcultural gathering place.</p>
  </div>
  <ul>
    <li><strong>Name:</strong> Leland City Club</li>
    <li><strong>Address:</strong><br />400 Bagley St, Detroit, MI 48226, USA</li>
    <li><strong>Website:</strong> <a href="https://lelandcityclub.net/" target="_blank" rel="noopener">Leland City Club</a></li>
  </ul>
</div>`, '1983');

addTimedMarker(42.3626399, -83.0819244, `<div><img src="Assets/Lincoln Factory.jpg" alt="The Lincoln Factory" class="popup-img"><div class="popup-center"><strong>The Lincoln Factory</strong></div><div>
  <p>Created: 1908</p>
  <p>Built in 1908 for Warren Motor Car Co. and later serving as the first Lincoln Motor Factory under Henry Leland in 1917, this National Register site shows how industrial spaces can be reimagined for cultural production. Converting an automotive factory into a contemporary venue connects Detroit's manufacturing legacy with its artistic present, converting an automotive factory into a music and arts venue for sonic experimentation and community gathering. The transformation contests assumptions about what former production sites should be, resisting luxury condo conversions in favor of accessible cultural infrastructure that replaces assembly lines with sound and collective experience.</p>
</div>
  <ul>
    <li><strong>Name:</strong> The Lincoln Factory</li>
    <li><strong>Address:</strong><br />1240 Holden St, Detroit, MI 48202, USA</li>
    <li><strong>Website:</strong> <a href="https://thelincolnfactory.com/" target="_blank" rel="noopener">thelincolnfactory.com</a></li>
  </ul>
</div>`, '1908');

addTimedMarker(42.3311594, -83.0730077, `<div>
  <img src="Assets/Motor City Wine.jpg" alt="Motor City Wine" class="popup-img" loading="lazy"
       style="width:100%; max-height:140px; object-fit:cover; border-radius:6px;">
  <div class="popup-center"><strong>Motor City Wine</strong></div>
  <div>
    <p>Created: 2013</p>
    <p>Motor City Wine challenged who gets to claim certain kinds of nighttime space in Detroit. When owners David and Melissa Armin-Parcells moved from a temporary downtown spot to Corktown's former Express Bar in 2013, expanding to 2,000 square feet with outdoor patio and parking, they brought small-producer, organic-focused wine culture into historically blue-collar territory. By hosting musicians and DJs alongside wine service, the venue contested the idea that "highbrow" leisure and working-class neighborhoods are incompatible. Motor City Wine navigated Corktown's contested transformation by arguing that nightlife diversity, from techno clubs to wine bars, strengthens rather than displaces community identity, reimagining who belongs in spaces of cultural consumption.</p>
  </div>
  <ul>
    <li><strong>Name:</strong> Motor City Wine</li>
    <li><strong>Address:</strong><br/>1949 Michigan Ave, Detroit, MI 48216, USA</li>
    <li><strong>Website:</strong> <a href="https://motorcitywine.com/" target="_blank" rel="noopener">motorcitywine.com</a></li>
  </ul>
</div>`, '2013');

addTimedMarker(42.3668187, -83.0767079, `<div><img src="Assets/Northern Lights Lounge.jpg" alt="Northern Lights Lounge" class="popup-img"><div class="popup-center"><strong>Northern Lights Lounge</strong></div><div>
  <p>Created: 2004</p>
  <p>Since 2004, co-owners Solaka, Steele, and Visee have transformed 660 W. Baltimore, converting an asphalt parking lot into a brick-paved patio with trees, layering Sunday brunch atop nightlife programming. This "all things to some people" philosophy contests profit-driven specialization: as a restaurant, bar, music venue, and outdoor gathering space, Northern Lights reimagines urban infrastructure through flexible use. Sound programming and multi-use design create temporal diversity that sustains community ownership rather than displacement, turning a single block in Detroit's New Center into contested commons space.</p>
</div>
  <ul>
    <li><strong>Name:</strong> Northern Lights Lounge</li>
    <li><strong>Address:</strong><br/>660 W. Baltimore, Detroit, MI</li>
    <li><strong>Website:</strong> <a href="https://www.northernlightslounge.com/" target="_blank" rel="noopener">northernlightslounge.com</a></li>
  </ul>
</div>`, '2004');

addTimedMarker(42.3338199, -83.0499098, `<div><img src="Assets/Speaker Box.jpg" alt="SPKR BOX" class="popup-img"><div class="popup-center"><strong>SPKRBOX</strong></div><div>
  <p>Created: 2022</p>
  <p>SPKRBOX makes Detroit's techno heritage part of everyday life. Born from Urban Bean Co., the Movement festival's "unofficial official" coffee shop since 2000, it reopened in 2022 as a Euro-style cafe with a full bar, blurring the line between daytime coffee runs and nighttime hangouts. The venue pushes back against treating electronic music culture as something temporary or special-occasion, instead embedding techno into daily rhythms. What was once a seasonal festival gathering spot becomes a year-round community space where sonic resistance lives permanently.</p>
</div>
  <ul>
    <li><strong>Name:</strong> SPKRBOX</li>
    <li><strong>Address:</strong><br />1501 Holden St, Detroit, MI 48208, USA</li>
    <li><strong>Website:</strong> <a href="https://spkrbox.bar/" target="_blank" rel="noopener">spkrbox.bar</a></li>
  </ul>
</div>`, '2022');

addTimedMarker(42.3357666, -83.0487215, `<div><img src="Assets/paramita.jpg" alt="Paramita Sound" class="popup-img"><div class="popup-center"><strong>Paramita Sound</strong></div><div>
  <p>Created: 2015</p>
  <p>Paramita Sound emerged from a converted warehouse space in Detroit's Eastern Market district. Today, it serves as a boutique recording studio and event space, attracting experimental musicians and sound artists who push the boundaries of electronic and ambient music. This transformation from industrial storage to sonic laboratory exemplifies Detroit's ability to reimagine abandoned spaces as incubators for avant-garde artistic expression.</p>
</div>
  <ul>
    <li><strong>Name:</strong> Paramita Sound</li>
    <li><strong>Address:</strong><br />1517 Broadway St, Detroit, MI 48226, USA</li>
    <li><strong>Website:</strong> <a href="https://www.paramitasound.com/about" target="_blank" rel="noopener">paramitasound.com</a></li>
  </ul>
</div>`, '2015');

addTimedMarker(42.3791133, -83.0592492, `<div><img src="Assets/russell_industrial_center.jpg" alt="Russell Industrial Center" class="popup-img"><div class="popup-center"><strong>Russell Industrial Center</strong></div><div>
  <p>Created: 1915</p>
  <p>Built in 1915 as a manufacturing complex for the Murray Body Corporation, the Russell Industrial Center once produced automobile bodies for Detroit's booming auto industry. Now it houses over 150 artists, musicians, and creative businesses, hosting underground raves and experimental music events that draw diverse crowds seeking authentic Detroit culture. The complex stands as a monument to Detroit's post-industrial renaissance, where the machinery of capitalism has been reclaimed as a playground for artistic resistance.</p>
</div>
  <ul>
    <li><strong>Name:</strong> Russell Industrial Center</li>
    <li><strong>Address:</strong><br />1600 Clay St, Detroit, MI 48211, USA</li>
    <li><strong>Website:</strong> <a href="https://www.russellindustrialcenter.com/history" target="_blank" rel="noopener">russellindustrialcenter.com</a></li>
  </ul>
</div>`, '1915');

addTimedMarker(42.3440836, -83.0615332, `<div><img src="Assets/detroit_shipping_company.jpg" alt="Detroit Shipping Company" class="popup-img"><div class="popup-center"><strong>Detroit Shipping Company</strong></div><div>
  <p>Created: 2018</p>
  <p>Opened in 2018, Detroit Shipping Company repurposed 21 shipping containers on the site of a former mail sorting facility to create a unique food hall and entertainment venue. The space now hosts DJs, live music, and community events, becoming a gathering spot for young professionals and creatives in the Cass Corridor area. This innovative use of modular, transportable architecture reflects Detroit's embrace of temporary and adaptive spaces that can shift with the city's evolving cultural needs.</p>
</div>
  <ul>
    <li><strong>Name:</strong> Detroit Shipping Company</li>
    <li><strong>Address:</strong><br />474 Peterboro St, Detroit, MI 48201, USA</li>
    <li><strong>Website:</strong> <a href="https://www.detroitshippingcompany.com/our-story" target="_blank" rel="noopener">detroitshippingcompany.com</a></li>
  </ul>
</div>`, '2018');

addTimedMarker(42.3754522, -83.0654343, `<div><img src="Assets/red_door_digital.jpg" alt="Red Door Gallery" class="popup-img"><div class="popup-center"><strong>Red Door Gallery</strong></div><div>
  <p>Created: 2010</p>
  <p>Red Door Digital began in the early 2010s in a former print shop, maintaining the industrial character of its North End location. The venue operates as both a gallery and underground music space, hosting techno and house events for Detroit's dedicated electronic music community. By preserving the raw aesthetic of its working-class origins while fostering cutting-edge digital art and music, Red Door embodies the tension between Detroit's industrial past and its technological future.</p>
</div>
  <ul>
    <li><strong>Name:</strong> Red Door Gallery</li>
    <li><strong>Address:</strong><br />7500 Oakland Ave, Detroit, MI 48211, USA</li>
    <li><strong>Website:</strong> <a href="https://www.facebook.com/RDDPrinting/" target="_blank" rel="noopener">Facebook Page</a></li>
  </ul>
</div>`, '2010');

addTimedMarker(42.3511427, -83.060109, `<div><img src="Assets/magic_stick.jpg" alt="Magic Stick" class="popup-img"><div class="popup-center"><strong>Magic Stick</strong></div><div>
  <p>Created: 1991</p>
  <p>Magic Stick opened in 1991 on the second floor of the Majestic Theatre complex, originally designed as a billiards hall in what was once a 1915 vaudeville theater. Today it functions as an intimate live music venue featuring indie rock, hip-hop, and electronic acts, drawing a diverse crowd of music enthusiasts who appreciate its legendary sound system and storied history.</p>
  <p>The venue's evolution from vaudeville to billiards to cutting-edge music space mirrors Detroit's own transformation, constantly reinventing itself while honoring the ghosts of its entertainment past.</p>
  </div>
  <ul>
    <li><strong>Name:</strong> Magic Stick</li>
    <li><strong>Address:</strong><br />4120 Woodward Ave, Detroit, MI 48201, USA</li>
    <li><strong>Website:</strong> <a href="https://www.majesticdetroit.com/about/the-magic-stick/" target="_blank" rel="noopener">majesticdetroit.com</a></li>
  </ul>
</div>`, '1991');

// AFTER all addTimedMarker(...) calls, add markers to the map and slider in chronological order
(function commitPendingMarkersInChronOrder(){
  // sort by numeric year ascending; non-numeric times go last
  pendingMarkers.sort(function(a,b){
    var at = parseInt(a.time, 10);
    var bt = parseInt(b.time, 10);
    if (isNaN(at)) at = Infinity;
    if (isNaN(bt)) bt = Infinity;
    return at - bt;
  });

  // add sorted markers to map, sliderLayer and allMarkers
  pendingMarkers.forEach(function(p){
    p.marker.addTo(map);
    sliderLayer.addLayer(p.marker);
    allMarkers.addLayer(p.marker);
  });
})();

// compute numeric min/max years from pendingMarkers (used to initialize slider)
var _years = pendingMarkers.map(function(p){ return parseInt(p.time,10); }).filter(function(n){ return !isNaN(n); }).sort(function(a,b){ return a-b; });
var sliderMinYear = _years.length ? _years[0] : null;
var sliderMaxYear = _years.length ? _years[_years.length-1] : null;

// Initialize the time slider control
var sliderControl = L.control.sliderControl({
  position: 'topright',
  layer: sliderLayer, //this is the layer group we created earlier
  timeAttribute: 'time',
  isEpoch: false,
  showAllOnStart: true,
  range: false,
  followTime: false,        // <-- disable follow so slider doesn't auto-pan the map
  alwaysShowDate: true,
  dateFormat: 'YYYY',
  speedSlider: false,
  autoPlay: false,
  maxSpeed: 2000,
  step: 1
});

// this adds the slider control to the map
map.addControl(sliderControl);

//this starts the slider
sliderControl.startSlider();

// attach lightweight detection for slider interaction / changes
(function attachSliderInteractionGuards(){
  window.__lastSliderChange = 0;
  window.__sliderInteracting = false;
  function markSliderChange(){ window.__lastSliderChange = Date.now(); }

  // try to find the slider DOM (jQuery UI or HTML range fallback)
  var s = document.querySelector('.leaflet-control-slider, .slider-control, .leaflet-control.slider-control');
  if (!s) return;

  var ui = s.querySelector('.ui-slider');
  var range = s.querySelector('input[type="range"]');

  [s, ui, range].forEach(function(el){
    if (!el) return;
    el.addEventListener('input', markSliderChange, {passive:true});
    el.addEventListener('change', markSliderChange, {passive:true});
    el.addEventListener('mousedown', function(){ window.__sliderInteracting = true; }, {passive:true});
    el.addEventListener('mouseup', function(){ window.__sliderInteracting = false; }, {passive:true});
    el.addEventListener('touchstart', function(){ window.__sliderInteracting = true; }, {passive:true});
    el.addEventListener('touchend', function(){ window.__sliderInteracting = false; }, {passive:true});
  });
})();
 
// Consolidated map.whenReady: run once after slider + markers present
map.whenReady(function(){
  // recalc size (important when using fixed-top navbar)
  try { map.invalidateSize(); } catch(e){}

  if (allMarkers && allMarkers.getLayers && allMarkers.getLayers().length) {
    try {
      map.fitBounds(allMarkers.getBounds(), { paddingTopLeft: [0,160], padding: [20,20] });
      setTimeout(function(){
        var targetZoom = Math.min(map.getZoom() + 2, 14);
        map.setZoom(targetZoom);
        map.panBy([0, -80], { animate: true });
      }, 350);
    } catch(err){
      console.warn('fitBounds failed (no valid bounds)', err);
    }
  }
});

/*
  Helper: try to programmatically set slider to a given time (best-effort across different SliderControl APIs)
*/
function setSliderTime(t) {
  if (!t) return false;
  var attempts = ['setTime','setCurrentTime','setDate','setValue','moveTo'];
  for (var i = 0; i < attempts.length; i++) {
    var fn = attempts[i];
    if (sliderControl && typeof sliderControl[fn] === 'function') {
      try { sliderControl[fn](t); return true; } catch(e){ /* ignore */ }
    }
  }
  // some builds expose nested slider object
  if (sliderControl && sliderControl.slider) {
    if (typeof sliderControl.slider.setValue === 'function') {
      try { sliderControl.slider.setValue(t); return true; } catch(e){}
    }
    // jQuery UI-style slider might emit 'slide' events; try trigger if present
    if (typeof sliderControl.slider.val === 'function') {
      try { sliderControl.slider.val(t); return true; } catch(e){}
    }
  }
  // DOM fallback: find any range/input element inside the control and set its value
  var el = document.querySelector('.leaflet-control-slider input[type="range"], .slider-control input[type="range"], .leaflet-slider input[type="range"], .slider-control .ui-slider-range');
  if (el) {
    try { el.value = t; el.dispatchEvent(new Event('input')); return true; } catch(e){}
  }
  return false;
}

/*
  When a popup opens, pan/zoom the map so the popup is visible and set the slider to the popup's time.
  This ensures slider movement <-> map/popup movement happens simultaneously.
*/
map.on('popupopen', function(e){
  try {
    var popup = e.popup;
    var source = popup && popup._source;
    if (!source) return;

    // if slider was just moved or user is interacting with it, skip auto-pan/sync
    var since = Date.now() - (window.__lastSliderChange || 0);
    if (window.__sliderInteracting || since < 500) {
      // still set slider time only if you want slider to reflect popup-open from user clicks:
      // if popup was opened by a non-slider user action, let it update slider; here we skip to avoid recursion.
      return;
    }

    // set slider time if marker has one (best-effort)
    var t = (source.options && source.options.time) || (source.time || null);
    if (t) setSliderTime(t);

    // ensure popup is visible and shift it above the fixed navbar (only when not suppressed)
    var latlng = (typeof source.getLatLng === 'function') ? source.getLatLng() : null;
    if (latlng) {
      map.panTo(latlng, { animate: true });

      setTimeout(function(){
        try {
          var popupEl = popup.getElement && popup.getElement();
          var popupH = (popupEl && (popupEl.offsetHeight || popupEl.clientHeight)) || 200;
          var navbarH = 160;
          var shift = Math.ceil(popupH / 2) + navbarH - 40;
          shift = Math.max(shift, navbarH);
          map.panBy([0, -shift], { animate: true });
        } catch(e){}
      }, 220);
    }
  } catch(err){ console.warn('popupopen handler error', err); }
});
</script>

<script>
  // Force Leaflet to recalc layout after everything has loaded,
  // and print basic diagnostic info to the console.
  window.addEventListener('load', function(){
    try {
      var mapEl = document.getElementById('map');
      console.log('#map element:', mapEl);
      if (mapEl) console.log('#map rect:', mapEl.getBoundingClientRect());
    } catch(e){}

    if (window.map && typeof map.invalidateSize === 'function') {
      try { map.invalidateSize(); } catch(e){}
      // a second call after a short delay often fixes timing/layout race issues
      setTimeout(function(){ try { map.invalidateSize(); } catch(e){} }, 300);
      console.log('map.invalidateSize() called');
      try { console.log('map.getCenter():', map.getCenter(), 'zoom:', map.getZoom()); } catch(e){}
      try { console.log('allMarkers count:', allMarkers && allMarkers.getLayers && allMarkers.getLayers().length); } catch(e){}
    } else {
      console.warn('window.map is not defined or invalidateSize() unavailable');
    }
  });
</script>

<script>
// list pending / map markers
console.log('pendingMarkers:', pendingMarkers && pendingMarkers.length);
console.table((pendingMarkers||[]).map(p => ({ lat: p.marker.getLatLng().lat, lng: p.marker.getLatLng().lng, time: p.time })));
console.log('allMarkers count:', allMarkers && allMarkers.getLayers && allMarkers.getLayers().length);
console.table((allMarkers.getLayers||[]).map(m => ({ lat: m.getLatLng().lat, lng: m.getLatLng().lng, time: (m.options && m.options.time) || m.time })));

// if markers exist but are off-screen, fit map to them:
if (allMarkers && allMarkers.getBounds && allMarkers.getLayers().length) {
  map.fitBounds(allMarkers.getBounds(), { paddingTopLeft: [0,160], padding: [20,20] });
}
</script>

<script>
  // diagnostic: print slider DOM info after load
  window.addEventListener('load', function(){
    setTimeout(function(){
      var el = document.querySelector('.leaflet-control-slider, .slider-control, .leaflet-control.slider-control');
      if (!el) {
        console.error('Slider element not found in DOM.');
      } else {
        console.log('Slider element found:', el);
        try {
          var rect = el.getBoundingClientRect();
          console.log('Slider rect:', rect);
          var cs = window.getComputedStyle(el);
          console.log('Slider computed style: top=' + cs.top + ', left=' + cs.left + ', position=' + cs.position + ', z-index=' + cs.zIndex + ', width=' + cs.width);
        } catch(e){ console.warn('Unable to read slider metrics', e); }
      }
      // also log any JS errors related to SliderControl (optional)
      if (window.sliderControl) console.log('sliderControl object:', sliderControl);
    }, 400);
  });
</script>
